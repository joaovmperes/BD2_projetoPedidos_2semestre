/*BD2 - 2o Bim -Atividade de SQL - Exercícios de DDL e DML - trigger, function e Select -
Queries dificuldade alta*/

--A

SELECT * FROM VIEW_ESTOQUE;

    SELECT DISPONIVEL FROM VIEW_ESTOQUE VE INNER JOIN PRODUTO P ON P.DESCRICAO = VE.PRODUTO WHERE CODIGO = 201;

CREATE OR REPLACE TRIGGER TRG_ITEM_PRODUTO_BI
BEFORE INSERT ON ITEM_PRODUTO
FOR EACH ROW
DECLARE
FUTURO_DISPONIVEL NUMBER;
DISPONIVEL NUMBER;
BEGIN
        SELECT DISPONIVEL INTO DISPONIVEL FROM VIEW_ESTOQUE VE INNER JOIN PRODUTO P ON P.DESCRICAO = VE.PRODUTO WHERE CODIGO = :NEW.CODIGO_PRO;
        FUTURO_DISPONIVEL := DISPONIVEL - :NEW.QUANTIDADE;
        IF FUTURO_DISPONIVEL < 0 THEN
        RAISE_APPLICATION_ERROR (-20998, 'ERRO: quantidade insuficiente do produto no estoque');
        END IF;
END;
    
--B
CREATE OR REPLACE FUNCTION EXISTENCIA_PRODUTO (CODIGOP NUMBER)
RETURN VARCHAR2 IS
EXISTENCIA VARCHAR2(30);
CODIGO_IN_PRODUTO NUMBER;
BEGIN
    SELECT MAX(CODIGO) INTO CODIGO_IN_PRODUTO FROM PRODUTO WHERE CODIGOP = CODIGO;
    IF CODIGO_IN_PRODUTO IS NOT NULL THEN
        EXISTENCIA := 'EXISTE';
    ELSE 
        EXISTENCIA := 'NAO EXISTE';
    END IF;
    RETURN EXISTENCIA;
END;
        
    
    
    
    